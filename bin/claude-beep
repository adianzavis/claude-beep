#!/usr/bin/expect -f

# Simple expect wrapper that replaces claude command

# Find the original claude CLI dynamically
set claude_path ""

# First try nvm locations specifically (most common for Claude Code)
set nvm_dir "$env(HOME)/.nvm"
if {[file exists $nvm_dir]} {
    foreach version_dir [glob -nocomplain "$nvm_dir/versions/node/*/lib/node_modules/@anthropic-ai/claude-code/cli.js"] {
        if {[file exists $version_dir]} {
            set claude_path $version_dir
            break
        }
    }
}

# If nvm didn't work, try to find claude in PATH and resolve symlinks
if {$claude_path == ""} {
    foreach path [split [exec printenv PATH 2>/dev/null] :] {
        set claude_candidate "$path/claude"
        if {[file exists $claude_candidate]} {
            # Skip our own wrapper
            if {$path == "/opt/homebrew/bin"} {
                continue
            }
            
            # Check if it's a symlink and resolve it
            while {[file type $claude_candidate] == "link"} {
                set claude_candidate [file readlink $claude_candidate]
                # Handle relative symlinks
                if {![string match "/*" $claude_candidate]} {
                    set claude_candidate "$path/$claude_candidate"
                }
            }
            
            # Check if it's a Node.js file (contains shebang or is large)
            if {[file exists $claude_candidate] && [file readable $claude_candidate]} {
                set claude_path $claude_candidate
                break
            }
        }
    }
}

if {$claude_path == ""} {
    puts stderr "Error: Could not find original claude CLI"
    exit 1
}

set original_claude $claude_path

# Get command line arguments
set claude_args [lrange $argv 0 end]

# Variables to track beep state
set allow_beep 1

# Start the original claude process with node
if {[llength $claude_args] > 0} {
    spawn node $original_claude {*}$claude_args
} else {
    spawn node $original_claude
}

# Set timeout to never timeout
set timeout -1

# Make expect transparent - pass through all input/output
interact {
    -o -re "(Do you want to proceed|Opened changes in|‚ùØ)" {
        # Only beep if beeping is allowed
        if {$allow_beep == 1} {
            # Execute beep-disturb command
            catch {
                exec beep-disturb &
            }
            set allow_beep 0
        }
    }
    -i -re "\r" {
        # User pressed Enter - re-enable beeping for next prompt
        set allow_beep 1
    }
}